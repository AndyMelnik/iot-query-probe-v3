# Security Policy

## Supported Versions

| Version | Supported          |
| ------- | ------------------ |
| 1.x     | :white_check_mark: |

## Reporting a Vulnerability

If you discover a security vulnerability, please report it by:

1. **DO NOT** create a public GitHub issue
2. Email the maintainers directly (add your security contact)
3. Include detailed steps to reproduce the vulnerability
4. Allow up to 48 hours for initial response

## Security Measures

### Authentication

- **Navixy App Connect**: Primary authentication through Navixy SSO
- **JWT Tokens**: HS256 signed, 24-hour expiration
- **Token Storage**: JWT stored in localStorage (per Navixy App Connect spec)
- **Credential Encryption**: Fernet (AES-128) for stored database credentials
- **Bearer Token Auth**: All API requests require `Authorization: Bearer <token>`

### Database Security

- **Parameterized Queries**: All user input is parameterized (no SQL injection)
- **Identifier Sanitization**: Table/column names validated against strict regex `^[a-zA-Z_][a-zA-Z0-9_]*$`
- **Query Timeout**: 5-minute limit prevents runaway queries
- **Row Limits**: Maximum 10,000 rows per query
- **No Direct DB Access**: Database URLs never exposed to client

### API Security

- **Rate Limiting**: 100 requests per 60 seconds per IP
- **Input Validation**: Pydantic models validate all input
- **Error Sanitization**: Database errors don't leak credentials
- **CORS**: Configurable origins (restrict in production)
- **Dev Mode Protection**: Dev endpoints disabled by default (`DEV_MODE=false`)

### Security Headers

Applied via nginx and Next.js:

- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: SAMEORIGIN`
- `X-XSS-Protection: 1; mode=block`
- `Referrer-Policy: strict-origin-when-cross-origin`
- `Permissions-Policy: geolocation=(), microphone=(), camera=()`
- `Cache-Control: no-store` (for API responses)

### HTML Export Security

- **XSS Prevention**: All user data is HTML-escaped before insertion
- **Filename Sanitization**: Export filenames are sanitized to prevent injection

## Production Deployment (Render.com)

### Required Environment Variables

```bash
# JWT_SECRET - Auto-generated by Render, or set manually:
export JWT_SECRET=$(openssl rand -hex 32)

# Restrict CORS origins (NEVER use * in production)
export CORS_ORIGINS="https://your-app.onrender.com,https://dashboard.tools.datahub.navixy.com"

# Disable debug mode (hides SQL in responses)
export DEBUG_MODE=false

# Disable dev mode endpoints (IMPORTANT for production)
export DEV_MODE=false
```

### ⚠️ Dev Mode Protection

The application includes development endpoints that allow direct database URL connections:

- `POST /api/connection/test` - Test database connection
- `POST /api/query/execute-dev` - Execute query with direct DB URL

**These endpoints are protected by the `DEV_MODE` environment variable:**

- When `DEV_MODE=false` (default): Endpoints return 403 Forbidden
- When `DEV_MODE=true`: Endpoints are accessible (local development only)

In production on Render.com, `DEV_MODE` is set to `false` by default in render.yaml.

### Render.com Deployment Checklist

1. ✅ JWT_SECRET is auto-generated
2. ✅ DEV_MODE=false (default)
3. ✅ DEBUG_MODE=false (default)
4. ⚠️ Update CORS_ORIGINS to your specific domains
5. ✅ Health check configured at /health
6. ✅ HTTPS enforced by Render

### Post-Deployment Verification

```bash
# Verify health endpoint
curl https://YOUR_APP.onrender.com/health

# Verify dev endpoints are blocked
curl -X POST https://YOUR_APP.onrender.com/api/connection/test \
  -H "Content-Type: application/json" \
  -d '{"databaseUrl":"postgresql://test:test@localhost/test"}'
# Should return 403 Forbidden

# Verify auth endpoint exists
curl https://YOUR_APP.onrender.com/api/auth/status
```

## Architecture Security

```
┌─────────────────────────────────────────────────────┐
│                    Render.com                       │
├─────────────────────────────────────────────────────┤
│  ┌──────────────────────────────────────────────┐  │
│  │              nginx (port 10000)               │  │
│  │  - TLS termination                           │  │
│  │  - Security headers                          │  │
│  │  - Rate limiting (via backend)               │  │
│  └──────────┬──────────────────────┬────────────┘  │
│             │                      │               │
│             ▼                      ▼               │
│  ┌──────────────────┐  ┌────────────────────────┐ │
│  │ FastAPI Backend  │  │   Next.js Frontend     │ │
│  │ (port 8001)      │  │   (port 3000)          │ │
│  │                  │  │                        │ │
│  │ - JWT validation │  │ - Static assets        │ │
│  │ - API endpoints  │  │ - React UI             │ │
│  │ - Query builder  │  │ - Auth state mgmt      │ │
│  └────────┬─────────┘  └────────────────────────┘ │
│           │                                        │
│           ▼                                        │
│  ┌──────────────────┐                              │
│  │ Encrypted Creds  │                              │
│  │ (/tmp storage)   │                              │
│  └────────┬─────────┘                              │
│           │                                        │
└───────────┼────────────────────────────────────────┘
            │
            ▼
    ┌───────────────┐
    │  IoT Database │
    │  (PostgreSQL) │
    └───────────────┘
```

## Things NOT to Do

- ❌ Never commit `.env` files
- ❌ Never log passwords or connection strings
- ❌ Never expose database structure in error messages
- ❌ Never use `CORS_ORIGINS=*` in production
- ❌ Never set `DEV_MODE=true` in production
- ❌ Never disable SSL verification

## Dependency Security

Run security audits regularly:

```bash
# Python
pip install safety
safety check -r requirements.txt

# Node.js
cd frontend
npm audit
npm audit fix
```

## Known Limitations

1. **Session Storage**: Credentials stored in filesystem (not suitable for multi-server deployments without shared storage like Redis)
2. **No Per-Row Authorization**: All authenticated users can query all data their database credentials allow
3. **Single Token per User**: Token refresh requires re-authentication through Navixy

## Contact

For security issues, contact: [Add security contact email]
